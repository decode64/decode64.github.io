<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="icon" type="image/png" sizes="100x100" href="../assets/favicon.png">

    <title>Everything You Need To Know To Pass PageSpeed With A Perfect Score | decode64 </title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">

    <script src="/assets/highlight.min.js" defer="true"></script>

    <style type="text/css">
    
    /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}body{margin:0;padding:0;font-family:'Montserrat', sans-serif;font-smooth:always;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:geometricPrecision}h1{margin:0;margin-bottom:40px}p{margin:25px 0;line-height:25px}pre.highlight{max-width:100%;overflow-x:scroll}a{text-decoration:none;color:#0066FF}code.language-plaintext{color:#FF0000;font-family:Ubuntu Mono, monospace}.container{max-width:630px;margin-left:150px}@media screen and (max-width: 600px){.container{max-width:630px;width:100%;margin-left:0 !important}}.highlight{margin-left:20px}.header span{margin-left:20px}.tags{list-style-type:none;margin:0;padding:0}.tags li{display:inline;border:1px solid #000;padding:2px 6px;margin-right:10px;font-size:12px}.copy{text-align:center;font-size:10px;margin-top:20px;margin-bottom:10px}.c-post-end{margin-top:40px;margin-bottom:25px;width:100%;background:url("../assets/post-end.svg") no-repeat;height:12px}.l-post{margin-top:35px}.l-post img{margin:15px auto;display:block}.l-post__date{padding-left:25px;margin:30px 0}.l-post__content{padding-left:25px}.l-post__cta{margin-bottom:25px}@media screen and (max-width: 600px){.l-post{padding:0 10px !important}.l-post h1{padding:0 !important}.l-post .highlight{margin-left:0 !important}.l-post__content{padding:0 !important}}/*!
  Theme: a11y-light
  Author: @ericwbailey
  Maintainer: @ericwbailey

  Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css
*/.hljs{background:#fefefe;color:#545454}.hljs-comment,.hljs-quote{color:#696969}.hljs-variable,.hljs-template-variable,.hljs-tag,.hljs-name,.hljs-selector-id,.hljs-selector-class,.hljs-regexp,.hljs-deletion{color:#d91e18}.hljs-number,.hljs-built_in,.hljs-literal,.hljs-type,.hljs-params,.hljs-meta,.hljs-link{color:#aa5d00}.hljs-attribute{color:#aa5d00}.hljs-string,.hljs-symbol,.hljs-bullet,.hljs-addition{color:#008000}.hljs-title,.hljs-section{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}@media screen and (-ms-high-contrast: active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-string,.hljs-symbol,.hljs-type,.hljs-quote{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:bold}}

    </style>
  </head>
  <body>
    <div class="container">
      <section class="header">
        <a href="/" >
          <img src="/assets/decode64-logo.svg" alt="Decode64 Logo" width=100 height=34 />
        </a>
        <span>Adriano Luz</span>
      </section>

      <section class="l-post">
        <div class="l-post__date">
          Jul 19, 2021
        </div>
        <h1>Everything You Need To Know To Pass PageSpeed With A Perfect Score</h1>
        <div class="l-post__content">
          <p>How long do you wait for a page to load? Not much time, I guess.</p>

<p>You are not the only one who doesn’t like to wait a long time until a page loads. In fact, page loading performance is one of the most important factors for a good user experience on the web.</p>

<p>As Jakob Nielsen says in this <a href="https://www.nngroup.com/articles/website-response-times/">article</a>:</p>

<blockquote>
  <p>A snappy user experience beats a glamorous one, for the simple reason that people engage more with a site when they can move freely and focus on the content instead of on their endless wait.</p>
</blockquote>

<p>Page loading performance is so important that google now uses it as a <a href="https://developers.google.com/search/blog/2021/04/more-details-page-experience">ranking factor</a> in search results. In other words, your SEO now depends on your page performance too.</p>

<p>Because of this, many developers are now trying to optimize their website metrics using google’s PageSpeed Insights tool to get the best score possible.</p>

<p>In this post I’ll discuss everything you need to know to optimize page performance and get a perfect score on PageSpeed. First I’ll present the main factors that affect page loading speed, then, the metrics that are used to measure page performance, the tools used to measure them and finally discuss some techniques to improve page performance.</p>

<h2 id="how-the-browser-renders-web-pages">How The Browser Renders Web Pages</h2>

<p>Before optimizing web pages we need to understand the process of rendering pages to the screen.</p>

<p>My <a href="https://decode64.dev/from-html-to-the-screen-how-browsers-render-web-pages/">previous article</a> presented an overview of how HTML and CSS files are parsed and combined to render a page on the screen. Let’s briefly review this process considering the performance related aspects of it.</p>

<h3 id="css-and-render-block">CSS And Render Block</h3>

<p>The process of rendering a web page in the browser starts by downloading the HTML file from a server. As soon as the browser receives the first bytes of the HTML it starts to parse it progressively to construct the DOM tree.</p>

<p>During the DOM parsing process the parser can find a link tag to a CSS file. When this tag is found, the parser immediately dispatches a request to download the CSS file and continues to parse the HTML. The CSS download occurs in parallel with HTML parsing.</p>

<p>Now imagine that the parser finished constructing the DOM but is still downloading CSS files. In this situation the browser can’t render anything until all CSS is downloaded and parsed otherwise a page with no styling will be displayed to the user. Worse than that, the unstyled page would be displayed and updated as soon as all CSS is downloaded and parsed, causing what is called a <strong>flash of unstyled content</strong> (FOUC).</p>

<p>To avoid causing a FOUC, the browser has to wait for all CSS to be downloaded and parsed before displaying the page. For this reason we say that CSS is a <strong>render blocking</strong> resource.</p>

<h3 id="what-about-javascript">What About Javascript?</h3>

<p>During the HTML parsing the browser can also encounter <code class="language-plaintext highlighter-rouge">script</code> tags. Like CSS, the browser dispatches a request to download the javascript file immediately but, instead of continuing the HTML parsing, it pauses until the javascript is downloaded and executed.</p>

<p>The entire DOM construction process has to be paused because javascript can manipulate the DOM by adding or removing elements to it, thus altering the structure of the original DOM parsed from the HTML. For this reason javascript is considered a <strong>parser blocking</strong> resource.</p>

<p>Another important property from javascript is that it can also manipulate element styles. When any style manipulation call happens from javascript, the browser has to verify that all known CSS has been downloaded and parsed before allowing the script to execute the style reading or manipulation. If the CSS is not ready, the script execution will be paused until the CSS parsing is done to ensure that the script has the most up-to-date style information for the page.</p>

<p>Quick recap:</p>

<ul>
  <li>CSS blocks HTML render</li>
  <li>Javascript blocks HTML parsing (and render)</li>
  <li>CSS blocks Javascript</li>
</ul>

<h2 id="improving-performance">Improving Performance</h2>

<p>The main goal of website optimization is to improve the performance perceived by the users. The best way to accomplish this is by displaying the first useful bits of information (above the fold content) for users as fast as possible.</p>

<p>Knowing how CSS and Javascript resources affect the process of HTML parsing we can now start to optimize our pages to avoid any render blocking and display the content above the fold faster. Let’s explore some strategies that can be used to improve the page performance.</p>

<h3 id="remove-unused-resources">Remove Unused Resources</h3>

<p>The most obvious, but often difficult to implement strategy to improve website performance, is to remove unused content. This includes unused HTML, unused CSS and unused Javascript.</p>

<p>The problem of unused content is that the HTML and CSS parsers will have to do additional work to parse the unused content even though they won’t be painted. As for Javascript the problem is the same. The interpreter will still have to parse script code that won’t be executed.</p>

<p>By removing unused resources you can decrease the script, css and html size, thus improving the resource download time as well as requiring less work from CSS/HTML parsers and from the Javascript interpreter to render the page.</p>

<h3 id="embed-critical-css">Embed Critical CSS</h3>

<p>This strategy consists in splitting CSS files into <em>critical</em> and <em>non-critical</em> and embedding the critical CSS in the page HTML files.</p>

<p>The critical CSS consists of rules needed to render above the fold content while the non-critical CSS consists of rules used only by parts of the page that are not displayed immediately, like components rendered below the fold, modals and hidden menus.</p>

<p>After identifying all the critical rules, a <code class="language-plaintext highlighter-rouge">style</code> tag can be used to inline these rules directly into the HTML file. This will void a second network round trip by the browser to fetch the critical CSS. As an effect, the page rendering process won’t be blocked by CSS download and the above the fold can be rendered much faster.</p>

<h3 id="lazy-load-non-critical-css">Lazy Load Non Critical CSS</h3>

<p>Since the non critical CSS is not required on the initial page load, it can safely be loaded after the above the initial fold content is rendered.</p>

<p>To properly apply this strategy, a small javascript is required. The reason being that, as discussed before, any <code class="language-plaintext highlighter-rouge">link</code> tag to a CSS resource will cause the browser to pause the render process until all the CSS is downloaded and parsed.</p>

<p>The following javascript snippet can be used to load CSS files after the initial page load:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">link</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">rel</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">stylesheet</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">href</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">path/to/noncritical.css</span><span class="dl">'</span><span class="p">);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Basically it executes a script to insert the non critical css in the DOM and make the browser download, parse and apply the styles defined in the file. Note that this script will only be executed on the window <code class="language-plaintext highlighter-rouge">onload</code> event. This is required to make sure that the initial page has been completely rendered before the non critical CSS is inserted, avoiding this new CSS to block the initial render.</p>

<h3 id="async-javascript-loading">Async Javascript Loading</h3>

<p>The <code class="language-plaintext highlighter-rouge">script</code> tag supports two attributes that are useful to load scripts without blocking the HTML parser. These attributes are <code class="language-plaintext highlighter-rouge">async</code> and <code class="language-plaintext highlighter-rouge">defer</code>.</p>

<p>Both attributes can be used to tell the browser to load script files in background while the DOM is constructed. The main difference between these two attributes is the moment the downloaded script will be executed.</p>

<p>Scripts loaded with <code class="language-plaintext highlighter-rouge">defer</code> are executed only after the HTML parsing is done. For this reason, <code class="language-plaintext highlighter-rouge">defer</code> scripts won’t block parsing.</p>

<p><code class="language-plaintext highlighter-rouge">Async</code> scripts, on the other hand, are executed as soon as they are available. If the browser finishes downloading an <code class="language-plaintext highlighter-rouge">async</code> script while the HTML is being parsed, it will pause the parsing to execute the script.</p>

<p>For this reason <code class="language-plaintext highlighter-rouge">defer</code> should be preferred over <code class="language-plaintext highlighter-rouge">async</code> to load javascript.</p>

<h3 id="resource-preloading">Resource Preloading</h3>

<p>The resource preloading allows the browser to dispatch a request to download a resource that will be used soon. This way, the resource is already available when the browser needs it.</p>

<p>Resource preloading works with any kind of resource like CSS, javascript, images and even json fetched from an API.</p>

<p>The following tag is used to preload resources. Note that you should specify the kind of resource you’re loading in the <code class="language-plaintext highlighter-rouge">as</code> attribute:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"preload"</span> <span class="na">href=</span><span class="s">"style.css"</span> <span class="na">as=</span><span class="s">"style"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>The preloading is particularly useful to tell the browser to download the non critical CSS before it is actually needed. That speeds up the non critical CSS processing without impacting the critical part of the page rendering.</p>

<h3 id="use-compression">Use Compression</h3>

<p>After tackling all the basic page render blocking strategies presented above, some additional work can be done to ensure that critical resources are loaded as fast as possible.</p>

<p>One of them is by using HTTP compression. All current browsers support <code class="language-plaintext highlighter-rouge">gzip</code> and <code class="language-plaintext highlighter-rouge">brotli</code> compression. It’s also easy to find tools to allow your server to compress files before sending them to the browser.</p>

<h3 id="improve-server-response-time">Improve Server Response Time</h3>

<p>The idea is simple. The faster a server can deliver the content to the browser, the sooner the browser can start parsing and rendering it.</p>

<p>However this is highly dependent on the server infrastructure and tools used to build the site. Some ideas to improve the server speed includes optimizing SQL queries, finding and fixing slow code and using caching when possible.</p>

<h2 id="performance-metrics">Performance Metrics</h2>

<p>It is essential for any performance improvement to have a set of standard metrics to measure if the optimizations are returning a positive effect. Let’s take a look at the current three most important performance metrics for web performance.</p>

<h3 id="largest-contentful-paint-lcp">Largest Contentful Paint (LCP)</h3>

<p>The <em>largest contentful paint</em> metric represents the time between the initial request to load a page and the paint of the largest page element above the fold. The largest element can be an image, a video poster, a background defined in css with <code class="language-plaintext highlighter-rouge">url()</code> or a block of text.</p>

<p>It is very common to have an image as the page LCP element. If that’s the case, the resource preloading can be used to start loading it sooner. Also, it is important to resize all images to a dimension closer to the final displayed size to decrease the file size. Image metadata removal can be helpful too.</p>

<p>This metric is part of the core web vitals and has an impact on SEO ranking. A measured time of 2.5 seconds or less is considered a good value.</p>

<h3 id="first-input-delay-fid">First Input Delay (FID)</h3>

<p>The <em>first input delay</em> metric represents the time between the first user interaction with a site and the time the browser responds to the interaction.</p>

<p>The main factor that impacts on FID is the time taken by javascript to setup all interaction events for the page. For this reason it’s important to execute the minimum possible javascript code at the page load to avoid blocking the setup of input events.</p>

<p>This metric is also part of the core web vitals and impacts your SEO ranking. A measured time of 100ms or less is considered a good value.</p>

<h3 id="time-to-first-byte-ttfb">Time To First Byte (TTFB)</h3>

<p>The <em>time to first byte</em> measures the time between the initial request to load a page and the first byte received as a response by the browser. It is a good metric to measure the server response time.</p>

<p>This metric is not part of the core web vitals and doesn’t impact SEO ranking directly. But a good TTFB will help to get a good score on all other performance metrics.</p>

<h2 id="measuring-performance">Measuring Performance</h2>

<h3 id="pagespeed">PageSpeed</h3>

<p><a href="https://developers.google.com/speed/pagespeed/insights/">PageSpeed</a> is the main tool to measure website performance. It uses lighthouse to measure and report many metrics and, based on the results, presents a few insights.</p>

<p>It is important to note that the score given by this tool is not what is used by google as a ranking factor. Google, instead, uses data collected from real users (called “field data”). The PageSpeed report can display the field data collected by Google depending on the site’s size and relevance.</p>

<h3 id="chrome-lighthouse">Chrome Lighthouse</h3>

<p>Another way to get a performance report is through the lighthouse tab on chrome developer tools. It can be accessed by right clicking on the page then selecting “Inspect” and navigating to the “Lighthouse” tab.</p>

<p>The main advantage of this tool is that it can be used to measure the performance of sites that are still in development and running on environments not accessible from the internet.</p>

<h3 id="getting-data-from-field">Getting Data From Field</h3>

<p>PageSpeed and Lighthouse are good tools to get an overview of a website’s performance. But the only way to know the real performance is by measuring it in the field.</p>

<p>Google provides a <a href="https://github.com/GoogleChrome/web-vitals">javascript library</a> to measure LCP, FID, TTFB and a few other metrics directly from the user’s perspective. This script can be used to collect all the necessary data and send them to a server for processing and reporting.</p>

<p>It is particularly important to measure the web vitals metrics from real users since this is what is used as a ranking factor by google.</p>

<h2 id="in-conclusion">In Conclusion</h2>

<p>Website optimization is a complex task. I hope this guide can help you to optimize your website, get a good score on pagespeed and improve the SEO ranking of your pages.</p>

        </div>

        <div class="c-post-end"></div>
        <div class="l-post__cta">
          <em>
            If you have any questions, comments or feedback, reach me on twitter at <a href="https://twitter.com/decode64">@decode64</a>.
          </em>
        </div>

        <ul class="tags">
          
          <li>performance</li>
          
          <li>pagespeed</li>
          
          <li>UX</li>
          
        </ul>
      </section>

      <div class="copy">2021 © Adriano Luz</div>
    </div>

    <script>
      function highlight() {
        if (typeof hljs !== 'undefined') { hljs.highlightAll() }
        else { setTimeout(highlight, 1000) }
      }
      highlight()
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76506964-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-76506964-1');
    </script>
  </body>
</html>
